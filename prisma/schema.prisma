generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BookingStatus {
  REQUESTED
  ASSIGNED
  EN_ROUTE
  ARRIVED
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum SenderType {
  RIDER
  DRIVER
  DISPATCHER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
  DEACTIVATED
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum SupportTicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model User {
  id        String      @id
  email     String      @unique
  name      String?
  role      String?
  isAdmin   Boolean     @default(false)
  status    UserStatus  @default(ACTIVE)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  driver              Driver?
  rider               Rider?
  dispatcher          Dispatcher?
  supportTickets      SupportTicket[]
  createdNotifications SystemNotification[]
  complianceLogs      ComplianceLog[]
}

model Rider {
  id    String    @id
  user  User      @relation(fields: [id], references: [id])
  phone String?
  
  // Accessibility preferences
  alwaysRequestWheelchair Boolean @default(false)
  needsAssistance         Boolean @default(false)
  
  bookings         Booking[]        @relation("RiderBookings")
  savedLocations   SavedLocation[]
  paymentMethods   PaymentMethod[]
}

model Driver {
  id                 String              @id
  user               User                @relation(fields: [id], references: [id])
  isOnline           Boolean             @default(false)
  vehicleMake        String?
  vehicleModel       String?
  vehiclePlate       String?
  wheelchairCapable  Boolean             @default(false)
  lastLat            Float?
  lastLng            Float?
  docsVerified       Boolean             @default(false)
  licenseNumber      String?
  insuranceExpiry    DateTime?
  wheelchairTraining Boolean             @default(false)
  phone              String?
  
  // Verification & Compliance
  verificationStatus VerificationStatus  @default(PENDING)
  dbsCheckDate       DateTime?
  dbsExpiryDate      DateTime?
  dbsCertificateUrl  String?
  trainingCompletedDate DateTime?
  trainingCertificateUrl String?
  
  // Financial
  commissionRate     Float               @default(0.15) // 15% default
  totalEarnings      Float               @default(0)
  pendingPayout      Float               @default(0)
  
  updatedAt          DateTime            @updatedAt
  bookings           Booking[]           @relation("DriverBookings")
  verificationDocuments DriverDocument[]
}

model Booking {
  id                String        @id @default(cuid())
  rider             Rider         @relation("RiderBookings", fields: [riderId], references: [id])
  riderId           String
  driver            Driver?       @relation("DriverBookings", fields: [driverId], references: [id])
  driverId          String?

  pickupAddress     String
  dropoffAddress    String
  pickupLat         Float?
  pickupLng         Float?
  dropoffLat        Float?
  dropoffLng        Float?
  pickupTime        DateTime

  requiresWheelchair Boolean       @default(false)
  specialNotes       String?
  priceEstimate      Json?
  paymentIntentId    String?
  status             BookingStatus @default(REQUESTED)
  estimatedDistance  Float?
  estimatedDuration  Float?

  riderPhone         String?
  driverPhone        String?

  finalFareAmount    Float?
  finalFareCurrency  String?       @default("GBP")

  pinCode            Int
  pickupVerified     Boolean       @default(false)
  
  // Ride documentation (filled by driver at completion)
  rideQuality        String?       // "excellent" | "good" | "fair" | "poor"
  clientComfort      String?       // "very_comfortable" | "comfortable" | "neutral" | "uncomfortable"
  accessibilityNotes String?       // Any accessibility-specific notes
  issuesReported     String?       // Any issues during the ride
  documentedAt       DateTime?     // When the ride was documented
  
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  messages           Message[]
}

model Message {
  id        String     @id @default(cuid())
  booking   Booking    @relation(fields: [bookingId], references: [id])
  bookingId String
  sender    SenderType
  text      String
  createdAt DateTime   @default(now())
}

model Settings {
  id               Int      @id @default(autoincrement())
  baseFare         Float    @default(6.0)
  perKm            Float    @default(1.8)
  wheelchairMult   Float    @default(1.15)
  provider         String   @default("fallback")
  requirePickupPin  Boolean  @default(true)
  sendReceipts      Boolean  @default(true)
  updatedAt         DateTime @updatedAt
}

model SavedLocation {
  id        String   @id @default(cuid())
  rider     Rider    @relation(fields: [riderId], references: [id], onDelete: Cascade)
  riderId   String
  
  label     String   // "Home", "Work", "Hospital", etc.
  address   String
  latitude  Float
  longitude Float
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([riderId])
}

model PaymentMethod {
  id               String   @id @default(cuid())
  rider            Rider    @relation(fields: [riderId], references: [id], onDelete: Cascade)
  riderId          String
  
  stripePaymentMethodId String @unique
  last4            String   // Last 4 digits of card
  brand            String   // "visa", "mastercard", etc.
  expiryMonth      Int
  expiryYear       Int
  isDefault        Boolean  @default(false)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([riderId])
}

// Dispatcher Model
model Dispatcher {
  id          String   @id
  user        User     @relation(fields: [id], references: [id])
  phone       String?
  region      String?  // Geographic region assigned
  shift       String?  // "morning", "afternoon", "evening", "night"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Driver Verification Documents
model DriverDocument {
  id            String             @id @default(cuid())
  driver        Driver             @relation(fields: [driverId], references: [id], onDelete: Cascade)
  driverId      String
  
  documentType  String             // "LICENSE", "INSURANCE", "DBS", "TRAINING", "VEHICLE_REGISTRATION"
  documentUrl   String
  status        VerificationStatus @default(PENDING)
  uploadedAt    DateTime           @default(now())
  reviewedAt    DateTime?
  reviewedBy    String?            // Admin user ID
  notes         String?
  expiryDate    DateTime?
  
  @@index([driverId])
  @@index([status])
}

// Support Tickets
model SupportTicket {
  id          String                @id @default(cuid())
  user        User                  @relation(fields: [userId], references: [id])
  userId      String
  
  subject     String
  description String
  priority    SupportTicketPriority @default(MEDIUM)
  status      SupportTicketStatus   @default(OPEN)
  category    String?               // "PAYMENT", "RIDE_ISSUE", "TECHNICAL", "ACCOUNT", "OTHER"
  
  bookingId   String?               // Optional reference to related booking
  assignedTo  String?               // Admin user ID
  
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  resolvedAt  DateTime?
  
  @@index([userId])
  @@index([status])
  @@index([priority])
}

// System Notifications (broadcast by admins)
model SystemNotification {
  id          String   @id @default(cuid())
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdById String
  
  title       String
  message     String
  targetRole  String?  // "RIDER", "DRIVER", "DISPATCHER", null = all
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  expiresAt   DateTime?
  
  @@index([isActive])
  @@index([targetRole])
}

// Compliance & Audit Logs
model ComplianceLog {
  id          String   @id @default(cuid())
  admin       User     @relation(fields: [adminId], references: [id])
  adminId     String
  
  action      String   // "APPROVED_DRIVER", "SUSPENDED_USER", "VIEWED_GDPR_DATA", "EXPORTED_REPORTS"
  targetType  String   // "USER", "DRIVER", "BOOKING", "DOCUMENT"
  targetId    String
  details     Json?
  
  createdAt   DateTime @default(now())
  
  @@index([adminId])
  @@index([targetType])
  @@index([createdAt])
}